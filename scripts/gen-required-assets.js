// scripts/gen-embed-asset-map.js
const fs = require("fs");
const path = require("path");

const projectRoot = path.join(__dirname, "..");
const assetsRoot = path.join(projectRoot, "assets", "loaded"); // adjust if needed
const outputFile = path.join(projectRoot, "generated", "assetMap.ts");

// file extensions to include (text-based)
const INCLUDE_RE =
  /\.(vert|frag|glsl|vs|fs|txt|json|cfg|shader|wgsl|glslfrag|glslvert|obj)$/i;

function walk(dir) {
  let results = [];
  const entries = fs.readdirSync(dir);
  for (const entry of entries) {
    const fullPath = path.join(dir, entry);
    const stat = fs.statSync(fullPath);
    if (stat.isDirectory()) {
      results = results.concat(walk(fullPath));
    } else if (INCLUDE_RE.test(entry)) {
      results.push(fullPath);
    }
  }
  return results;
}

if (!fs.existsSync(assetsRoot)) {
  console.error(`Assets root not found: ${assetsRoot}`);
  process.exit(1);
}

const files = walk(assetsRoot);

// Ensure output dir
fs.mkdirSync(path.dirname(outputFile), { recursive: true });

// Build TS content
const header = `// AUTO-GENERATED FILE — DO NOT EDIT
// Generated by scripts/gen-embed-asset-map.js
// Embeds asset file contents as strings
\n`;

const lines = [
  header,
  "export const assetContents: Record<string, string> = {",
];

for (const file of files) {
  // key: path inside assetsRoot (e.g. "shaders/test.glsl.frag")
  const key = path.relative(assetsRoot, file).replace(/\\/g, "/");
  const raw = fs.readFileSync(file, "utf8");

  // JSON.stringify safely escapes the content for us
  const esc = JSON.stringify(raw);

  lines.push(`  ${JSON.stringify(key)}: ${esc},`);
}

lines.push("};", "");
lines.push("export const assetNames = Object.keys(assetContents);", "");

// write
fs.writeFileSync(outputFile, lines.join("\n"), "utf8");
console.log(`✅ Generated ${outputFile} with ${files.length} asset(s)`);
